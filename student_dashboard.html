<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Student Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: auto;
    padding: 20px;
    background: #f9f9f9;
  }
  h2 {
    text-align: center;
    color: #222;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 25px;
    background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 12px;
    border: 1px solid #ddd;
    text-align: left;
  }
  th {
    background: #333;
    color: white;
  }
  .loading, .error {
    text-align: center;
    margin-top: 30px;
    font-size: 18px;
  }
  .error {
    color: red;
  }
</style>
</head>
<body>

  <h2>Student Dashboard</h2>
  <div id="welcome"></div>

  <div id="loading" class="loading">Loading grades...</div>
  <div id="error" class="error" style="display:none;"></div>

  <table id="gradesTable" style="display:none;">
    <thead>
      <tr>
        <th>Subject</th>
        <th>Period</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody id="gradesBody"></tbody>
  </table>

<script>
  // Utility to get URL parameter
  function getQueryParam(param) {
    const params = new URLSearchParams(window.location.search);
    return params.get(param);
  }

  // Fetch approved grades from backend
  async function fetchGrades(userId) {
    const params = new URLSearchParams();
    params.append('action', 'getApprovedGrades');
    params.append('role', 'student');
    params.append('userId', userId);

    const response = await fetch('https://script.google.com/macros/s/AKfycbx_bqnFoB4ciSkrrGIObdPMUi_wreGB5RHqPlXKD7XkGpfZDixouRbuKdQER3Lj2OzL/exec', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: params.toString()
    });
    return response.json();
  }

  // Render grades in table
  function renderGrades(grades) {
    const tbody = document.getElementById('gradesBody');
    tbody.innerHTML = '';

    if (!grades || grades.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No grades found.</td></tr>';
      return;
    }

    grades.forEach(({Subject, GradePeriod, Score}) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${Subject || ''}</td>
        <td>${GradePeriod || ''}</td>
        <td style="color:${Score >= 70 ? 'blue' : 'red'};">${Score}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Main init function
  async function init() {
    const userId = getQueryParam('userId');
    const welcomeDiv = document.getElementById('welcome');
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const gradesTable = document.getElementById('gradesTable');

    if (!userId) {
      welcomeDiv.textContent = 'User ID missing. Please login again.';
      loadingDiv.style.display = 'none';
      return;
    }

    welcomeDiv.textContent = `Welcome, Student ID: ${userId}`;
    loadingDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    gradesTable.style.display = 'none';

    try {
      const data = await fetchGrades(userId);
      loadingDiv.style.display = 'none';

      if (data.success && Array.isArray(data.grades)) {
        renderGrades(data.grades);
        gradesTable.style.display = 'table';
      } else {
        errorDiv.textContent = data.message || 'No grades available';
        errorDiv.style.display = 'block';
      }
    } catch (err) {
      loadingDiv.style.display = 'none';
      errorDiv.textContent = 'Failed to fetch grades. Please try again later.';
      errorDiv.style.display = 'block';
      console.error(err);
    }
  }

  window.onload = init;
</script>

</body>
</html>
