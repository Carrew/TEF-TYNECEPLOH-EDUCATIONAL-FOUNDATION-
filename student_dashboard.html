<!DOCTYPE html>
<html>
<head>
  <title>Student Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #dashboard { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    select { padding: 6px; margin-top: 10px; }
  </style>
</head>
<body>

  <!-- Login Page -->
  <div id="loginPage">
    <h2>Student Login</h2>
    <input type="text" id="studentId" placeholder="Student ID"><br><br>
    <input type="password" id="pin" placeholder="PIN"><br><br>
    <button onclick="loginStudent()">Login</button>
    <p id="loginMessage" style="color:red;"></p>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <h2>Welcome Student</h2>
    <label for="periodSelect">Select Period:</label>
    <select id="periodSelect" onchange="filterResults()">
      <option value="">All Periods</option>
      <option value="1st Period">1st Period</option>
      <option value="2nd Period">2nd Period</option>
      <option value="3rd Period">3rd Period</option>
      <option value="4th Period">4th Period</option>
      <option value="5th Period">5th Period</option>
      <option value="6th Period">6th Period</option>
      <option value="Semester Exam">Semester Exam</option>
      <option value="Final Exam">Final Exam</option>
    </select>

    <table id="resultsTable">
      <thead>
        <tr>
          <th>Subject</th>
          <th>Score</th>
          <th>Period</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let studentIdGlobal = "";
    let allGrades = [];

    function loginStudent() {
      const studentId = document.getElementById("studentId").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const loginMsg = document.getElementById("loginMessage");

      if (!studentId || !pin) {
        loginMsg.innerText = "Please enter Student ID and PIN.";
        return;
      }

      const url = "https://script.google.com/macros/s/AKfycbxD4I6gTNaDa-HgtZQazLP2hZDOa-yEcyt0IBkJNJ008xMu6aDx3Gw0TuY-MgHv83qO/exec";
      fetch(`${url}?userId=${studentId}&pin=${pin}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            studentIdGlobal = data.studentId;
            document.getElementById("loginPage").style.display = "none";
            document.getElementById("dashboard").style.display = "block";
            loadGrades(studentIdGlobal);
          } else {
            loginMsg.innerText = "Login failed. Please check your ID and PIN.";
          }
        })
        .catch(err => {
          loginMsg.innerText = "Error connecting to server.";
        });
    }

    function loadGrades(studentId) {
      const url = "https://script.google.com/macros/s/AKfycbyv0XAPQGzY5NOT4SUe-FuNXkrkbmMQjUip/exec";
      fetch(`${url}?studentId=${studentId}`)
        .then(res => res.json())
        .then(data => {
          if (data.success && data.grades) {
            allGrades = data.grades.filter(g => g.Status === "Approved");
            displayResults(allGrades);
          } else {
            alert("Error fetching results.");
          }
        })
        .catch(() => alert("Failed to connect to server."));
    }

    function displayResults(grades) {
      const tableBody = document.getElementById("resultsTable").getElementsByTagName("tbody")[0];
      tableBody.innerHTML = "";

      grades.forEach(g => {
        const row = tableBody.insertRow();
        row.insertCell(0).innerText = g.Subject;
        row.insertCell(1).innerText = g.Score;
        row.insertCell(2).innerText = g.Period;
      });
    }

    function filterResults() {
      const period = document.getElementById("periodSelect").value;
      if (!period) {
        displayResults(allGrades);
      } else {
        const filtered = allGrades.filter(g => g.Period === period);
        displayResults(filtered);
      }
    }
  </script>

</body>
</html>
