<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }
    h1 {
      color: #444;
    }
    select {
      padding: 5px;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
    .score-low {
      color: red;
    }
    .score-high {
      color: blue;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Welcome, Student</h1>

  <label for="periodSelect">Filter by Period:</label>
  <select id="periodSelect">
    <option value="All">All</option>
    <option value="1st Period">1st Period</option>
    <option value="2nd Period">2nd Period</option>
    <option value="3rd Period">3rd Period</option>
    <option value="4th Period">4th Period</option>
    <option value="5th Period">5th Period</option>
    <option value="6th Period">6th Period</option>
    <option value="Semester Exam">Semester Exam</option>
    <option value="Final Exam">Final Exam</option>
  </select>

  <div id="error" class="error"></div>

  <table id="gradesTable" style="display:none">
    <thead>
      <tr>
        <th>Subject</th>
        <th>Score</th>
        <th>Period</th>
        <th>Teacher</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td><strong>Average</strong></td>
        <td colspan="3" id="averageCell">-</td>
      </tr>
    </tfoot>
  </table>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get("studentId");
    const apiUrl = "https://script.google.com/macros/s/AKfycbxD4I6gTNaDa-HgtZQazLP2hZDOa-yEcyt0IBkJNJ008xMu6aDx3Gw0TuY-MgHv83qO/exec";

    const errorDiv = document.getElementById("error");
    const table = document.getElementById("gradesTable");
    const tbody = table.querySelector("tbody");
    const averageCell = document.getElementById("averageCell");
    const periodSelect = document.getElementById("periodSelect");

    let allGrades = [];

    function fetchGrades() {
      if (!studentId) {
        errorDiv.textContent = "Missing student ID.";
        return;
      }

      fetch(`${apiUrl}?studentId=${studentId}`)
        .then(res => res.json())
        .then(data => {
          if (data.success && Array.isArray(data.grades)) {
            allGrades = data.grades.filter(g => g.Status === "Approved");
            renderTable("All");
          } else {
            errorDiv.textContent = "No approved grades found.";
          }
        })
        .catch(() => {
          errorDiv.textContent = "Error fetching results.";
        });
    }

    function renderTable(selectedPeriod) {
      tbody.innerHTML = "";
      let filtered = selectedPeriod === "All"
        ? allGrades
        : allGrades.filter(g => g.Period.trim() === selectedPeriod);

      if (filtered.length === 0) {
        table.style.display = "none";
        averageCell.textContent = "-";
        return;
      }

      let total = 0;

      filtered.forEach(g => {
        const row = document.createElement("tr");

        const subjectCell = document.createElement("td");
        subjectCell.textContent = g.Subject;
        row.appendChild(subjectCell);

        const scoreCell = document.createElement("td");
        scoreCell.textContent = g.Score;
        scoreCell.className = g.Score >= 70 ? "score-high" : "score-low";
        row.appendChild(scoreCell);

        const periodCell = document.createElement("td");
        periodCell.textContent = g.Period.trim();
        row.appendChild(periodCell);

        const teacherCell = document.createElement("td");
        teacherCell.textContent = g.TeacherID;
        row.appendChild(teacherCell);

        tbody.appendChild(row);
        total += Number(g.Score);
      });

      const avg = (total / filtered.length).toFixed(2);
      averageCell.textContent = avg;
      table.style.display = "table";
    }

    periodSelect.addEventListener("change", () => {
      renderTable(periodSelect.value);
    });

    fetchGrades();
  </script>
</body>
</html>
