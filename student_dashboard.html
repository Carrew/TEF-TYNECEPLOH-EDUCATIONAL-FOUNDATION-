<!DOCTYPE html>
<html>
<head>
  <title>Student Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
    .hidden { display: none; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    select, input, button { width: 100%; padding: 10px; margin: 10px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
  </style>
</head>
<body>

<div class="container">
  <div id="loginPanel">
    <h2>Student Login</h2>
    <input type="text" id="studentId" placeholder="Enter your Student ID" />
    <input type="password" id="pin" placeholder="Enter your PIN" />
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <div id="dashboardPanel" class="hidden">
    <h2>Welcome, <span id="studentName"></span></h2>

    <label>Filter by Period:</label>
    <select id="periodFilter" onchange="displayGrades()">
      <option value="">All Periods</option>
      <option value="1st Period">1st Period</option>
      <option value="2nd Period">2nd Period</option>
      <option value="3rd Period">3rd Period</option>
      <option value="Semester Exam">Semester Exam</option>
      <option value="4th Period">4th Period</option>
      <option value="5th Period">5th Period</option>
      <option value="6th Period">6th Period</option>
      <option value="Final Exam">Final Exam</option>
    </select>

    <table id="gradesTable">
      <thead>
        <tr>
          <th>Subject</th>
          <th>Score</th>
          <th>Period</th>
          <th>Status</th>
          <th>Reject Reason</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxD4I6gTNaDa-HgtZQazLP2hZDOa-yEcyt0IBkJNJ008xMu6aDx3Gw0TuY-MgHv83qO/exec";

window.onload = function () {
  const studentId = localStorage.getItem("studentId");
  const studentName = localStorage.getItem("studentName");

  if (studentId) {
    document.getElementById("loginPanel").classList.add("hidden");
    document.getElementById("dashboardPanel").classList.remove("hidden");
    document.getElementById("studentName").textContent = studentName || studentId;
    fetchGrades(studentId);
  }
};

function login() {
  const id = document.getElementById("studentId").value.trim();
  const pin = document.getElementById("pin").value.trim();

  if (!id || !pin) {
    document.getElementById("loginError").textContent = "Please enter ID and PIN.";
    return;
  }

  fetch(`${scriptURL}?userId=${id}&pin=${pin}`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        localStorage.setItem("studentId", data.studentId);
        localStorage.setItem("studentName", data.name || data.studentId);
        document.getElementById("studentName").textContent = data.name || data.studentId;
        document.getElementById("loginPanel").classList.add("hidden");
        document.getElementById("dashboardPanel").classList.remove("hidden");
        fetchGrades(data.studentId);
      } else {
        document.getElementById("loginError").textContent = "Invalid ID or PIN.";
      }
    })
    .catch(error => {
      console.error("Login error:", error);
      document.getElementById("loginError").textContent = "Network error.";
    });
}

let grades = [];

function fetchGrades(studentId) {
  fetch(`${scriptURL}?studentId=${studentId}`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        grades = data.grades || [];
        displayGrades();
      } else {
        alert("Error fetching results.");
      }
    })
    .catch(error => {
      console.error("Fetch error:", error);
      alert("Error fetching results.");
    });
}

function displayGrades() {
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML = "";

  const selectedPeriod = document.getElementById("periodFilter").value;

  const filteredGrades = grades.filter(g => !selectedPeriod || g.Period.trim() === selectedPeriod.trim());

  if (filteredGrades.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5">No results found for this period.</td></tr>`;
    return;
  }

  filteredGrades.forEach(grade => {
    const row = `
      <tr>
        <td>${grade.Subject}</td>
        <td>${grade.Score}</td>
        <td>${grade.Period}</td>
        <td>${grade.Status}</td>
        <td>${grade.RejectReason || ""}</td>
      </tr>`;
    tbody.innerHTML += row;
  });
}
</script>

</body>
</html>
