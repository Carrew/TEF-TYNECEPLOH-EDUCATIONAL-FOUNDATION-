<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-top: 40px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f4f4f4; }
    input, select, button { padding: 6px; margin: 5px 0; }
    #studentsSearch { margin-bottom: 10px; width: 300px; }
    .hidden { display: none; }
  </style>
</head>
<body>

<h1>Teacher Dashboard</h1>

<div id="loginDiv">
  <label for="teacherIdInput">Enter Teacher ID:</label>
  <input id="teacherIdInput" type="text" />
  <button onclick="login()">Login</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<div id="dashboard" class="hidden">
  <button onclick="logout()">Logout</button>
  <h2>Welcome, <span id="teacherName"></span> (ID: <span id="teacherIdDisplay"></span>)</h2>

  <!-- Submit new grade -->
  <section>
    <h3>Submit New Grade</h3>
    <form id="submitGradeForm">
      <input type="text" id="newStudentId" placeholder="Student ID" required />
      <input type="text" id="newSubject" placeholder="Subject" required />
      <input type="number" id="newScore" placeholder="Score" min="0" max="100" required />
      <input type="text" id="newPeriod" placeholder="Period" required />
      <button type="submit">Submit Grade</button>
    </form>
    <p id="submitGradeMsg"></p>
  </section>

  <!-- Students list -->
  <section>
    <h3>Students Assigned</h3>
    <input type="text" id="studentsSearch" placeholder="Search students by name or ID" oninput="filterStudents()" />
    <table id="studentsTable">
      <thead>
        <tr><th>StudentID</th><th>Name</th><th>Class</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Grades sections -->
  <section>
    <h3>Approved Grades</h3>
    <table id="approvedGradesTable">
      <thead><tr><th>StudentID</th><th>Subject</th><th>Score</th><th>Period</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section>
    <h3>Submitted Grades</h3>
    <table id="submittedGradesTable">
      <thead><tr><th>StudentID</th><th>Subject</th><th>Score</th><th>Period</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section>
    <h3>Rejected Grades (Edit and Resubmit)</h3>
    <table id="rejectedGradesTable">
      <thead><tr><th>Row #</th><th>StudentID</th><th>Subject</th><th>Score</th><th>Period</th><th>Reject Reason</th><th>Edit</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<script>
  const scriptUrl = "https://script.google.com/macros/s/AKfycbw9P_XOd4k498l0e4WDbFqAF1asb2u4sRj_uX2B-2S1MvyWOeWQZqxy8dr13mPOdNOeuw/exec";

  const loginDiv = document.getElementById("loginDiv");
  const dashboard = document.getElementById("dashboard");
  const teacherNameSpan = document.getElementById("teacherName");
  const teacherIdDisplay = document.getElementById("teacherIdDisplay");
  const loginMsg = document.getElementById("loginMsg");

  let teacherId = null;

  function login() {
    teacherId = document.getElementById("teacherIdInput").value.trim();
    if (!teacherId) {
      loginMsg.textContent = "Please enter Teacher ID.";
      return;
    }
    loginMsg.textContent = "";
    localStorage.setItem("teacherId", teacherId);
    initDashboard();
  }

  function logout() {
    localStorage.removeItem("teacherId");
    localStorage.removeItem("teacherName");
    location.reload();
  }

  async function initDashboard() {
    teacherId = localStorage.getItem("teacherId");
    if (!teacherId) {
      loginDiv.style.display = "block";
      dashboard.classList.add("hidden");
      return;
    }
    loginDiv.style.display = "none";
    dashboard.classList.remove("hidden");
    teacherIdDisplay.textContent = teacherId;

    // Get teacher name from localStorage
    const teacherName = localStorage.getItem("teacherName");
    teacherNameSpan.textContent = teacherName ? teacherName : "Unknown";

    loadApprovedGrades();
    loadSubmittedGrades();
    loadRejectedGrades();
    loadStudentsList();
  }

  async function fetchJSON(url, options = {}) {
    try {
      const res = await fetch(url, options);
      return await res.json();
    } catch (e) {
      return { success: false, message: "Network or server error" };
    }
  }

  async function loadApprovedGrades() {
    const res = await fetchJSON(`${scriptUrl}?action=getTeacherGrades&teacherId=${encodeURIComponent(teacherId)}`);
    const tbody = document.querySelector("#approvedGradesTable tbody");
    tbody.innerHTML = "";
    if (!res.success) {
      tbody.innerHTML = `<tr><td colspan="4">Error loading grades: ${res.message}</td></tr>`;
      return;
    }
    if (res.data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='4'>No approved grades found.</td></tr>";
      return;
    }
    res.data.forEach(grade => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${grade.StudentID}</td><td>${grade.Subject}</td><td>${grade.Score}</td><td>${grade.Period}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function loadSubmittedGrades() {
    const res = await fetchJSON(`${scriptUrl}?action=viewSubmittedGrades&teacherId=${encodeURIComponent(teacherId)}`);
    const tbody = document.querySelector("#submittedGradesTable tbody");
    tbody.innerHTML = "";
    if (!res.success) {
      tbody.innerHTML = `<tr><td colspan="4">Error loading grades: ${res.message}</td></tr>`;
      return;
    }
    if (res.data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='4'>No submitted grades found.</td></tr>";
      return;
    }
    res.data.forEach(grade => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${grade.StudentID}</td><td>${grade.Subject}</td><td>${grade.Score}</td><td>${grade.Period}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function loadRejectedGrades() {
    const res = await fetchJSON(`${scriptUrl}?action=getRejectedGrades&teacherId=${encodeURIComponent(teacherId)}`);
    const tbody = document.querySelector("#rejectedGradesTable tbody");
    tbody.innerHTML = "";
    if (!res.success) {
      tbody.innerHTML = `<tr><td colspan="7">Error loading grades: ${res.message}</td></tr>`;
      return;
    }
    if (res.data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='7'>No rejected grades found.</td></tr>";
      return;
    }
    res.data.forEach((grade, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index + 2}</td>
        <td><input type="text" value="${grade.StudentID}" data-row="${index + 2}" data-field="StudentID"></td>
        <td><input type="text" value="${grade.Subject}" data-row="${index + 2}" data-field="Subject"></td>
        <td><input type="number" value="${grade.Score}" min="0" max="100" data-row="${index + 2}" data-field="Score"></td>
        <td><input type="text" value="${grade.Period}" data-row="${index + 2}" data-field="Period"></td>
        <td>${grade.RejectReason || ""}</td>
        <td><button onclick="resubmitGrade(${index + 2})">Save & Resubmit</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function resubmitGrade(rowNumber) {
    const fields = ["StudentID", "Subject", "Score", "Period"];
    const values = {};
    fields.forEach(field => {
      const input = document.querySelector(`input[data-row='${rowNumber}'][data-field='${field}']`);
      if (input) values[field.toLowerCase()] = input.value.trim();
    });

    if (!values.studentid || !values.subject || !values.score || !values.period) {
      alert("Please fill all fields before resubmitting.");
      return;
    }

    const formData = new URLSearchParams();
    formData.append("action", "editRejectedGrade");
    formData.append("rowNumber", rowNumber);
    formData.append("studentId", values.studentid);
    formData.append("subject", values.subject);
    formData.append("score", values.score);
    formData.append("period", values.period);
    formData.append("teacherId", teacherId);

    const res = await fetch(scriptUrl, {
      method: "POST",
      body: formData,
    }).then(r => r.json());

    if (res.success) {
      alert("Grade updated and resubmitted!");
      loadRejectedGrades();
      loadSubmittedGrades();
    } else {
      alert("Error: " + res.message);
    }
  }

  async function loadStudentsList() {
    const res = await fetchJSON(`${scriptUrl}?action=getStudentsByClass&teacherId=${encodeURIComponent(teacherId)}`);
    const tbody = document.querySelector("#studentsTable tbody");
    tbody.innerHTML = "";
    if (!res.success) {
      tbody.innerHTML = `<tr><td colspan="4">Error loading students: ${res.message}</td></tr>`;
      return;
    }
    if (res.data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='4'>No students found.</td></tr>";
      return;
    }
    res.data.forEach(student => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${student.StudentID}</td><td>${student.Name}</td><td>${student.Class}</td><td>${student.Status}</td>`;
      tbody.appendChild(tr);
    });
  }

  function filterStudents() {
    const filter = document.getElementById("studentsSearch").value.toLowerCase();
    const rows = document.querySelectorAll("#studentsTable tbody tr");
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(filter) ? "" : "none";
    });
  }

  document.getElementById("submitGradeForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const studentId = document.getElementById("newStudentId").value.trim();
    const subject = document.getElementById("newSubject").value.trim();
    const score = document.getElementById("newScore").value.trim();
    const period = document.getElementById("newPeriod").value.trim();

    if (!studentId || !subject || !score || !period) {
      document.getElementById("submitGradeMsg").textContent = "Please fill all fields.";
      return;
    }

    const formData = new URLSearchParams();
    formData.append("action", "submitGrade");
    formData.append("studentId", studentId);
    formData.append("subject", subject);
    formData.append("score", score);
    formData.append("period", period);
    formData.append("teacherId", teacherId);

    const res = await fetch(scriptUrl, {
      method: "POST",
      body: formData,
    }).then(r => r.json());

    if (res.success) {
      document.getElementById("submitGradeMsg").textContent = "Grade submitted successfully!";
      this.reset();
      loadSubmittedGrades();
    } else {
      document.getElementById("submitGradeMsg").textContent = "Error: " + res.message;
    }
  });

  window.onload = initDashboard;
</script>

</body>
</html>
