<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 1rem; }
  input, select, button { margin: 0.5rem 0; padding: 0.4rem; width: 100%; max-width: 300px; }
  ul { list-style-type: none; padding-left: 0; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; }
  li { padding: 0.4rem; cursor: pointer; border-bottom: 1px solid #eee; }
  li:hover { background-color: #f0f0f0; }
  .hidden { display: none; }
  .message { margin: 0.5rem 0; font-weight: bold; }
  label { display: block; margin-top: 1rem; }
</style>
</head>
<body>

<h1>Teacher Dashboard</h1>

<label for="teacherId">Your Teacher ID:</label>
<input type="text" id="teacherId" placeholder="Enter your Teacher ID" />

<button onclick="loadAssignedStudents()">Load Assigned Students</button>

<label for="searchStudent">Search Student:</label>
<input type="text" id="searchStudent" placeholder="Type to search students" oninput="filterStudents()" disabled />

<ul id="studentsList"></ul>

<form id="gradeForm" class="hidden" onsubmit="submitGrade(event)">
  <h3>Submit Grade</h3>
  <input type="hidden" id="selectedStudentId" />

  <label for="studentName">Student:</label>
  <input type="text" id="studentName" disabled />

  <label for="subject">Subject:</label>
  <input type="text" id="subject" required />

  <label for="score">Score:</label>
  <input type="number" id="score" min="0" max="100" required />

  <label for="period">Period:</label>
  <select id="period" required>
    <option value="">Select Period</option>
    <option value="1st Period">1st Period</option>
    <option value="2nd Period">2nd Period</option>
    <option value="3rd Period">3rd Period</option>
    <option value="Semester Exam">Semester Exam</option>
    <option value="Final Exam">Final Exam</option>
  </select>

  <button type="submit">Submit Grade</button>
</form>

<div id="message" class="message"></div>

<script>
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw9P_XOd4k498l0e4WDbFqAF1asb2u4sRj_uX2B-2S1MvyWOeWQZqxy8dr13mPOdNOeuw/exec";

  let assignedStudents = [];

  function loadAssignedStudents() {
    const teacherId = document.getElementById("teacherId").value.trim();
    if (!teacherId) {
      showMessage("Please enter your Teacher ID.");
      return;
    }
    fetch(`${WEB_APP_URL}?action=getAssignedStudents&teacherId=${encodeURIComponent(teacherId)}`)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          assignedStudents = data.students;
          populateStudentsList(assignedStudents);
          document.getElementById("searchStudent").disabled = false;
          showMessage(`Loaded ${assignedStudents.length} students.`);
          document.getElementById("gradeForm").classList.add("hidden");
        } else {
          showMessage(data.message);
          assignedStudents = [];
          populateStudentsList([]);
          document.getElementById("searchStudent").disabled = true;
          document.getElementById("gradeForm").classList.add("hidden");
        }
      })
      .catch(err => {
        showMessage("Error loading students.");
        console.error(err);
      });
  }

  function populateStudentsList(students) {
    const list = document.getElementById("studentsList");
    list.innerHTML = "";
    if (students.length === 0) {
      list.innerHTML = "<li>No students found.</li>";
      return;
    }
    students.forEach(s => {
      const li = document.createElement("li");
      li.textContent = `${s.name} (${s.class})`;
      li.dataset.studentId = s.studentId;
      li.dataset.studentName = s.name;
      li.onclick = () => selectStudent(li);
      list.appendChild(li);
    });
  }

  function filterStudents() {
    const query = document.getElementById("searchStudent").value.toLowerCase();
    const filtered = assignedStudents.filter(s => s.name.toLowerCase().includes(query));
    populateStudentsList(filtered);
  }

  function selectStudent(li) {
    const studentId = li.dataset.studentId;
    const studentName = li.dataset.studentName;
    document.getElementById("selectedStudentId").value = studentId;
    document.getElementById("studentName").value = studentName;
    document.getElementById("gradeForm").classList.remove("hidden");
    showMessage("");
  }

  function submitGrade(event) {
    event.preventDefault();
    const teacherId = document.getElementById("teacherId").value.trim();
    const studentId = document.getElementById("selectedStudentId").value;
    const subject = document.getElementById("subject").value.trim();
    const score = document.getElementById("score").value.trim();
    const period = document.getElementById("period").value;

    if (!teacherId || !studentId || !subject || !score || !period) {
      showMessage("Please fill all required fields.");
      return;
    }

    const formData = new URLSearchParams();
    formData.append("action", "submitGrade");
    formData.append("teacherId", teacherId);
    formData.append("studentId", studentId);
    formData.append("subject", subject);
    formData.append("score", score);
    formData.append("period", period);

    fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: formData.toString()
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showMessage(data.message);
          // Clear form except student info
          document.getElementById("subject").value = "";
          document.getElementById("score").value = "";
          document.getElementById("period").value = "";
        } else {
          showMessage(data.message);
        }
      })
      .catch(err => {
        showMessage("Error submitting grade.");
        console.error(err);
      });
  }

  function showMessage(msg) {
    document.getElementById("message").textContent = msg;
  }
</script>

</body>
</html>
