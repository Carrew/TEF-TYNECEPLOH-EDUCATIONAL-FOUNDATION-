<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fef2f5;
      color: #5b1a37; /* maroon */
      margin: 0; padding: 20px;
    }
    h1, h2 {
      color: #d6336c; /* pink */
      margin-bottom: 10px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    select, input[type=text], input[type=number] {
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #d6336c;
      border-radius: 5px;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #d6336c;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #a12c50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #d6336c;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #fcd3e0;
    }
    .section {
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 0 10px rgba(214, 51, 108, 0.15);
    }
    .loading {
      color: #a12c50;
      font-style: italic;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Teacher Dashboard</h1>
  <div>
    <strong>Teacher ID:</strong> <span id="teacherIdDisplay"></span>
    <button id="logoutBtn" style="background:#a12c50; margin-left:15px;">Logout</button>
  </div>

  <div class="section" id="classesSection">
    <h2>Your Classes and Students</h2>
    <div id="classesLoading" class="loading">Loading classes...</div>
    <div id="studentsList"></div>
  </div>

  <div class="section" id="submitGradeSection">
    <h2>Submit New Grade</h2>
    <form id="gradeForm">
      <label for="studentSelect">Select Student</label>
      <select id="studentSelect" required></select>

      <label for="subjectInput">Subject</label>
      <input type="text" id="subjectInput" placeholder="Enter subject" required />

      <label for="periodSelect">Period</label>
      <select id="periodSelect" required>
        <option value="">Select period</option>
        <option>1st Period</option>
        <option>2nd Period</option>
        <option>3rd Period</option>
        <option>Exam</option>
        <option>4th Period</option>
        <option>5th Period</option>
        <option>6th Period</option>
        <option>Final Exam</option>
      </select>

      <label for="scoreInput">Score</label>
      <input type="number" id="scoreInput" min="0" max="100" placeholder="Enter score" required />

      <button type="submit">Submit Grade</button>
      <div id="submitResult"></div>
    </form>
  </div>

  <div class="section" id="rejectedGradesSection">
    <h2>Rejected Grades - Edit & Resubmit</h2>
    <div id="rejectedLoading" class="loading">Loading rejected grades...</div>
    <table id="rejectedGradesTable" style="display:none;">
      <thead>
        <tr>
          <th>Student</th>
          <th>Subject</th>
          <th>Period</th>
          <th>Score</th>
          <th>Reject Reason</th>
          <th>Edit Score</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbw9P_XOd4k498l0e4WDbFqAF1asb2u4sRj_uX2B-2S1MvyWOeWQZqxy8dr13mPOdNOeuw/exec";

    let teacherId = localStorage.getItem("teacherId");
    if (!teacherId) {
      alert("No teacher ID found. Please login first.");
      window.location.href = "teacher_login.html";
    } else {
      document.getElementById("teacherIdDisplay").textContent = teacherId;
    }

    // Logout button clears localStorage and redirects
    document.getElementById("logoutBtn").onclick = () => {
      localStorage.removeItem("teacherId");
      window.location.href = "teacher_login.html";
    };

    // Global arrays
    let classes = [];
    let students = [];
    let rejectedGrades = [];

    async function fetchClassesAndStudents() {
      document.getElementById("classesLoading").style.display = "block";
      document.getElementById("studentsList").innerHTML = "";

      try {
        // Fetch teacher list to get classes for this teacher
        const teacherListRes = await fetch(`${endpoint}?action=getTeacherList`);
        const teacherListData = await teacherListRes.json();

        if (!teacherListData.success) throw new Error(teacherListData.message);

        const teacher = teacherListData.teachers.find(t => t.TeacherID === teacherId);
        if (!teacher) throw new Error("Teacher not found.");

        classes = teacher.Classes.split(",").map(c => c.trim());

        // Fetch all students
        const studentsRes = await fetch(`${endpoint}?action=getStudentList`);
        const studentsData = await studentsRes.json();

        if (!studentsData.success) throw new Error(studentsData.message);

        // Filter students belonging to teacher's classes
        students = studentsData.students.filter(s => classes.includes(s.Class));

        // Show students grouped by class
        const container = document.getElementById("studentsList");
        if (students.length === 0) {
          container.innerHTML = "<p>No students found in your classes.</p>";
        } else {
          const byClass = {};
          students.forEach(s => {
            if (!byClass[s.Class]) byClass[s.Class] = [];
            byClass[s.Class].push(s);
          });

          let html = "";
          for (const cls in byClass) {
            html += `<h3>Class: ${cls}</h3><ul>`;
            byClass[cls].forEach(stu => {
              html += `<li>${stu.Name} (${stu.StudentID})</li>`;
            });
            html += "</ul>";
          }
          container.innerHTML = html;
        }

        // Populate student dropdown for grade submission
        const studentSelect = document.getElementById("studentSelect");
        studentSelect.innerHTML = "";
        students.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.StudentID;
          opt.textContent = `${s.Name} (${s.StudentID})`;
          studentSelect.appendChild(opt);
        });
      } catch (err) {
        document.getElementById("studentsList").innerHTML = `<p style="color:red">${err.message}</p>`;
      } finally {
        document.getElementById("classesLoading").style.display = "none";
      }
    }

    async function fetchRejectedGrades() {
      document.getElementById("rejectedLoading").style.display = "block";
      const table = document.getElementById("rejectedGradesTable");
      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";

      try {
        const res = await fetch(`${endpoint}?action=getRejectedGrades&teacherId=${encodeURIComponent(teacherId)}`);
        const data = await res.json();

        if (!data.success) throw new Error(data.message);

        rejectedGrades = data.rejectedGrades;

        if (rejectedGrades.length === 0) {
          document.getElementById("rejectedGradesSection").innerHTML += "<p>No rejected grades to show.</p>";
          table.style.display = "none";
          return;
        }

        table.style.display = "table";

        // Populate rows
        rejectedGrades.forEach((grade, i) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${grade.StudentID}</td>
            <td>${grade.Subject}</td>
            <td>${grade.Period}</td>
            <td>${grade.Score}</td>
            <td>${grade.RejectReason}</td>
            <td><input type="number" min="0" max="100" value="${grade.Score}" data-index="${i}" style="width:60px"/></td>
            <td><button data-index="${i}" class="resubmitBtn">Resubmit</button></td>
          `;

          tbody.appendChild(tr);
        });

        // Add event listeners for resubmit buttons
        document.querySelectorAll(".resubmitBtn").forEach(btn => {
          btn.onclick = async (e) => {
            const idx = e.target.getAttribute("data-index");
            const newScoreInput = tbody.querySelector(`input[data-index="${idx}"]`);
            const newScore = newScoreInput.value;

            if (newScore === "" || newScore < 0 || newScore > 100) {
              alert("Please enter a valid score between 0 and 100.");
              return;
            }

            const gradeToUpdate = rejectedGrades[idx];

            const formData = new URLSearchParams();
            formData.append("action", "editRejectedGrade");
            formData.append("teacherId", teacherId);
            formData.append("studentId", gradeToUpdate.StudentID);
            formData.append("subject", gradeToUpdate.Subject);
            formData.append("period", gradeToUpdate.Period);
            formData.append("score", newScore);

            try {
              const res = await fetch(endpoint, {
                method: "POST",
                body: formData,
              });
              const result = await res.json();

              if (result.success) {
                alert("Grade resubmitted successfully!");
                fetchRejectedGrades();
              } else {
                alert("Error: " + result.message);
              }
            } catch (error) {
              alert("Network or server error.");
            }
          };
        });
      } catch (err) {
        document.getElementById("rejectedGradesSection").innerHTML = `<p style="color:red">${err.message}</p>`;
      } finally {
        document.getElementById("rejectedLoading").style.display = "none";
      }
    }

    async function submitGrade(event) {
      event.preventDefault();

      const studentId = document.getElementById("studentSelect").value;
      const subject = document.getElementById("subjectInput").value.trim();
      const period = document.getElementById("periodSelect").value;
      const score = document.getElementById("scoreInput").value;

      if (!studentId || !subject || !period || score === "") {
        alert("Please fill all fields.");
        return;
      }

      const formData = new URLSearchParams();
      formData.append("action", "submitGrade");
      formData.append("teacherId", teacherId);
      formData.append("studentId", studentId);
      formData.append("subject", subject);
      formData.append("period", period);
      formData.append("score", score);

      const resultDiv = document.getElementById("submitResult");
      resultDiv.textContent = "Submitting...";
      resultDiv.style.color = "#5b1a37";

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          body: formData,
        });
        const data = await res.json();

        if (data.success) {
          resultDiv.style.color = "green";
          resultDiv.textContent = "Grade submitted successfully!";
          // Clear form fields
          document.getElementById("gradeForm").reset();
          fetchRejectedGrades(); // Refresh rejected grades in case this submission resolves one
        } else {
          resultDiv.style.color = "red";
          resultDiv.textContent = "Error: " + data.message;
        }
      } catch (error) {
        resultDiv.style.color = "red";
        resultDiv.textContent = "Network or server error.";
      }
    }

    // Initialize
    fetchClassesAndStudents();
    fetchRejectedGrades();

    // Event listener for grade submission
    document.getElementById("gradeForm").addEventListener("submit", submitGrade);
  </script>
</body>
</html>
