<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reset Proprietor Credentials</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #fce4ec, #f8bbd0);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0; padding: 0;
  }
  .container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    padding: 30px 25px;
    width: 100%;
    max-width: 400px;
  }
  h2 {
    color: #d81b60;
    text-align: center;
    margin-bottom: 20px;
  }
  label {
    font-weight: bold;
    color: #333;
    display: block;
    margin-top: 10px;
  }
  input {
    width: 100%;
    padding: 10px;
    margin: 8px 0 18px 0;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 15px;
  }
  button {
    width: 100%;
    background-color: #d81b60;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  button:hover {
    background-color: #880e4f;
  }
  #message {
    text-align: center;
    margin-top: 15px;
    font-size: 15px;
  }
  .hidden {
    display: none;
  }
</style>
</head>
<body>

<div class="container">

  <!-- Step 1: Old credentials form -->
  <div id="oldCredentialsSection">
    <h2>Verify Old Credentials</h2>
    <label for="oldName">Old Name</label>
    <input type="text" id="oldName" placeholder="Enter old Name" />
    <label for="oldPin">Old PIN</label>
    <input type="password" id="oldPin" placeholder="Enter old PIN" />
    <button onclick="verifyOldCredentials()">Verify</button>
  </div>

  <!-- Step 2: New credentials form -->
  <div id="newCredentialsSection" class="hidden">
    <h2>Set New Credentials</h2>
    <label for="newName">New Name</label>
    <input type="text" id="newName" placeholder="Enter new Name" />
    <label for="newPin">New PIN</label>
    <input type="password" id="newPin" placeholder="Enter new PIN" />
    <button onclick="submitNewCredentials()">Submit</button>
  </div>

  <p id="message"></p>
</div>

<script>
  const url = 'https://script.google.com/macros/s/AKfycbw9P_XOd4k498l0e4WDbFqAF1asb2u4sRj_uX2B-2S1MvyWOeWQZqxy8dr13mPOdNOeuw/exec';

  function showMessage(msg, color = 'red') {
    const message = document.getElementById('message');
    message.style.color = color;
    message.textContent = msg;
  }

  async function verifyOldCredentials() {
    const oldName = document.getElementById('oldName').value.trim();
    const oldPin = document.getElementById('oldPin').value.trim();

    if (!oldName || !oldPin) {
      showMessage('Please enter old Name and PIN.');
      return;
    }

    // Call backend login API with old credentials to verify
    const formData = new URLSearchParams();
    formData.append('action', 'login');
    formData.append('role', 'principal');
    formData.append('id', oldName);
    formData.append('pin', oldPin);

    try {
      const response = await fetch(url, {
        method: 'POST',
        body: formData
      });
      const data = await response.json();

      if (data.success) {
        showMessage('Old credentials verified. Please enter new credentials.', 'green');
        // Hide old credentials section, show new credentials form
        document.getElementById('oldCredentialsSection').classList.add('hidden');
        document.getElementById('newCredentialsSection').classList.remove('hidden');
      } else {
        showMessage(data.message || 'Old credentials verification failed.');
      }
    } catch (e) {
      showMessage('Network or server error.');
      console.error(e);
    }
  }

  async function submitNewCredentials() {
    const newName = document.getElementById('newName').value.trim();
    const newPin = document.getElementById('newPin').value.trim();

    if (!newName || !newPin) {
      showMessage('Please enter new Name and PIN.');
      return;
    }

    showMessage('Submitting new credentials...', 'black');

    // Try multiple guesses for parameter names for new name
    const paramNameOptions = ['newName', 'newId', 'name'];
    let responseData = null;
    let success = false;
    let lastError = '';

    for (const paramName of paramNameOptions) {
      const formData = new URLSearchParams();
      formData.append('action', 'resetPrincipalCredentials');
      formData.append('role', 'principal');
      formData.append(paramName, newName);
      formData.append('newPin', newPin);

      try {
        const response = await fetch(url, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();

        if (data.success) {
          success = true;
          responseData = data;
          break;
        } else {
          lastError = data.message || 'Failed to update credentials.';
        }
      } catch (e) {
        lastError = 'Network or server error.';
        console.error(e);
      }
    }

    if (success) {
      showMessage('Credentials updated successfully!', 'green');
      localStorage.removeItem('principalName');
      localStorage.removeItem('principalPin');
      setTimeout(() => {
        window.location.href = 'principal_login.html';
      }, 1500);
    } else {
      showMessage(lastError || 'Failed to update credentials.');
    }
  }
</script>

</body>
</html>
