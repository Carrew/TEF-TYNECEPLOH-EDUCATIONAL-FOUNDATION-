<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Principal Dashboard - Update Info</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  /* Rich school colors for the page */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #d6336c; /* Rich pink */
    margin: 0;
    padding: 0;
  }

  .container {
    max-width: 450px;
    margin: 60px auto;
    background: #6d4c41; /* Rich brown */
    padding: 30px 25px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    color: #fff;
    transition: background 0.3s;
  }

  /* Step 2 highlight (slightly lighter brown) */
  .container.step2 {
    background: #7b5e57;
  }

  h2 {
    text-align: center;
    color: #fff;
    margin-bottom: 20px;
  }

  h3 {
    color: #f7b7c1; /* Muted pink for headings */
    margin-bottom: 15px;
  }

  label {
    display: block;
    margin-top: 15px;
    font-weight: 500;
    color: #f9c6d1;
  }

  input {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border-radius: 6px;
    border: 1px solid #f7b7c1;
    font-size: 15px;
    color: #333;
  }

  button {
    width: 100%;
    padding: 12px;
    margin-top: 20px;
    background: #f7b7c1;
    color: #5d4037;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }

  button:hover {
    background: #e88ca1;
  }

  .dot-loader span {
    display: inline-block;
    width: 6px;
    height: 6px;
    margin: 0 2px;
    background: #fff;
    border-radius: 50%;
    animation: blink 1s infinite;
  }

  .dot-loader span:nth-child(2) { animation-delay: 0.2s; }
  .dot-loader span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes blink {
    0%, 80%, 100% { opacity: 0; }
    40% { opacity: 1; }
  }

  .message {
    margin-top: 15px;
    font-weight: bold;
    min-height: 20px;
  }

  .success { color: #28a745; }
  .error { color: #dc3545; }

  .hidden { display: none; }
</style>
</head>
<body>

<div class="container" id="mainContainer">
  <h2><i class="fas fa-user-shield"></i> Principal Dashboard</h2>

  <!-- Step 1: Verification -->
  <div id="verifySection">
    <h3>Step 1: Verify Current Information</h3>
    <form id="verifyForm">
      <label for="currentName"><i class="fas fa-id-badge"></i> Current Name:</label>
      <input type="text" id="currentName" name="currentName" required>

      <label for="currentPIN"><i class="fas fa-key"></i> Current PIN:</label>
      <input type="password" id="currentPIN" name="currentPIN" required>

      <button type="submit">
        Verify
        <span class="dot-loader hidden" id="verifyLoader">
          <span></span><span></span><span></span>
        </span>
      </button>
    </form>
    <p id="verifyMessage" class="message"></p>
  </div>

  <!-- Step 2: Update -->
  <div id="updateSection" class="hidden">
    <h3>Step 2: Update Information</h3>
    <form id="updateForm">
      <label for="newName"><i class="fas fa-user-edit"></i> New Name:</label>
      <input type="text" id="newName" name="newName" required>

      <label for="newPIN"><i class="fas fa-key"></i> New PIN:</label>
      <input type="password" id="newPIN" name="newPIN" required>

      <button type="submit">
        Update
        <span class="dot-loader hidden" id="updateLoader">
          <span></span><span></span><span></span>
        </span>
      </button>
    </form>
    <p id="updateMessage" class="message"></p>
  </div>
</div>

<script>
const ROUTER_URL = "https://script.google.com/macros/s/AKfycbw9P_XOd4k498l0e4WDbFqAF1asb2u4sRj_uX2B-2S1MvyWOeWQZqxy8dr13mPOdNOeuw/exec";

let currentName = '';
let currentPIN = '';

function postToRouter(payload, callback, loaderElement) {
  loaderElement.classList.remove('hidden');
  loaderElement.parentElement.disabled = true;

  fetch(ROUTER_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams(payload)
  })
  .then(res => res.text())
  .then(text => {
    let response;
    try { response = JSON.parse(text); } 
    catch(e) { response = [{ status: "error", message: "Invalid server response" }]; }

    loaderElement.classList.add('hidden');
    loaderElement.parentElement.disabled = false;

    if (!Array.isArray(response)) response = [response];

    callback(response);
  })
  .catch(err => {
    loaderElement.classList.add('hidden');
    loaderElement.parentElement.disabled = false;
    callback([{ status: "error", message: err.message }]);
  });
}

// Step 1: Verify
document.getElementById('verifyForm').addEventListener('submit', function(e) {
  e.preventDefault();
  currentName = document.getElementById('currentName').value.trim();
  currentPIN = document.getElementById('currentPIN').value.trim();

  postToRouter({
    action: 'multiPrincipalVerifyUpdate',
    role: 'principal',
    updates: JSON.stringify([{ currentName, currentPIN }])
  }, function(response) {
    const msgElem = document.getElementById('verifyMessage');
    const container = document.getElementById('mainContainer');
    if (response[0].status === "success") {
      msgElem.className = 'message success';
      msgElem.textContent = response[0].message || "Verification successful! Moving to Step 2...";
      setTimeout(() => {
        document.getElementById('verifySection').classList.add('hidden');
        document.getElementById('updateSection').classList.remove('hidden');
        container.classList.add('step2'); // highlight Step 2 container
      }, 1000);
    } else {
      msgElem.className = 'message error';
      msgElem.textContent = response[0].message || "Verification failed";
    }
  }, document.getElementById('verifyLoader'));
});

// Step 2: Update
document.getElementById('updateForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const newName = document.getElementById('newName').value.trim();
  const newPIN = document.getElementById('newPIN').value.trim();

  postToRouter({
    action: 'multiPrincipalVerifyUpdate',
    role: 'principal',
    updates: JSON.stringify([{ currentName, currentPIN, newData: { Name: newName, PIN: newPIN } }])
  }, function(response) {
    const msgElem = document.getElementById('updateMessage');
    if (response[0].status === "success") {
      msgElem.className = 'message success';
      msgElem.textContent = response[0].message || "Information updated successfully!";
      currentName = newName;
      currentPIN = newPIN;
      // Redirect to principal login page after 1.2 seconds
      setTimeout(() => {
        window.location.href = 'principal_login.html';
      }, 1200);
    } else {
      msgElem.className = 'message error';
      msgElem.textContent = response[0].message || "Update failed";
    }
  }, document.getElementById('updateLoader'));
});
</script>

</body>
</html>
