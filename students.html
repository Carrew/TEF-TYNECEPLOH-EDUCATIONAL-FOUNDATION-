<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proprietor Student Management | TEF</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  /* RESET */
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
  body { background: #fdf2f7; color: #4b2e2e; line-height:1.6; padding: 20px; }

  /* LOGO & HEADER */
  header {
    display:flex; align-items:center; justify-content:center; gap:15px;
    margin-bottom: 30px;
  }
  header img { width:80px; border-radius:15px; box-shadow:0 6px 15px rgba(0,0,0,0.3); }
  header h1 { font-size:2rem; color:#d63384; text-transform:uppercase; }

  /* SUMMARY */
  #studentSummary { text-align:center; font-weight:700; margin-bottom:20px; font-size:1.1rem; }

  /* FORM CONTAINER */
  .form-container {
    background:#fff0f7; padding:20px; border-radius:15px;
    max-width:900px; margin:20px auto; box-shadow:0 6px 20px rgba(214,51,132,0.2);
  }
  .form-container h2 { color:#d63384; margin-bottom:15px; }
  label { display:block; margin-top:10px; font-weight:600; }
  input[type="text"], select { width:100%; padding:10px; margin-top:5px; border-radius:6px; border:1px solid #ccc; }
  button { margin-top:15px; padding:10px 18px; border:none; border-radius:30px; cursor:pointer; font-weight:600; transition:0.3s; }
  #saveBtn { background:#d63384; color:white; position:relative; }
  #saveBtn:hover { background:#a02363; transform:translateY(-2px); box-shadow:0 6px 12px rgba(214,51,132,0.4); }
  .form-container button[style] { background:#777; color:white; }
  .spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,0.6); border-top:2px solid white; border-radius:50%; animation:spin 0.8s linear infinite; position:absolute; right:10px; top:50%; transform:translateY(-50%);}
  @keyframes spin {0%{transform:translateY(-50%) rotate(0deg);}100%{transform:translateY(-50%) rotate(360deg);}}

  /* SEARCH */
  #searchContainer { max-width:900px; margin:20px auto; }
  #searchInput { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:16px; }

  /* TABLE */
  .table-container {
    background:#fff0f7; padding:20px; border-radius:15px;
    max-width:900px; margin:20px auto; box-shadow:0 6px 20px rgba(214,51,132,0.2);
    overflow-x:auto;
  }
  .table-container h2 { color:#d63384; margin-bottom:15px; }
  table { width:100%; border-collapse:collapse; }
  th, td { padding:10px; border:1px solid #ccc; text-align:center; }
  th { background:#d63384; color:white; }
  .actions button { margin:0 5px; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:14px; position:relative; }
  .actions button:hover { transform:translateY(-2px); box-shadow:0 4px 10px rgba(214,51,132,0.3); }

  /* DELETE CONFIRM */
  #deleteConfirm { display:none; max-width:400px; margin:10px auto; background:#fff; border:1px solid #ccc; padding:15px; border-radius:10px; box-shadow:0 6px 18px rgba(214,51,132,0.2); text-align:center; }

  /* MESSAGE */
  #message { max-width:900px; margin:15px auto; text-align:center; font-weight:700; }

  /* RESPONSIVE */
  @media(max-width:768px) {
    header { flex-direction:column; }
    header img { width:60px; }
  }
</style>
</head>
<body>

<header>
  <img src="https://raw.githubusercontent.com/Carrew/TEF-TYNECEPLOH-EDUCATIONAL-FOUNDATION-/refs/heads/main/Image/images/IMG-20250829-WA0074.jpg" alt="TEF Logo">
  <h1>Student Management</h1>
</header>

<div id="studentSummary">Loading total students...</div>

<div class="form-container">
  <h2>Add / Edit Student</h2>
  <form id="studentForm">
    <input type="hidden" id="editStudentId">
    <label for="studentName">Name</label>
    <input type="text" id="studentName" required>

    <label for="studentClass">Class</label>
    <input type="text" id="studentClass" required>

    <label for="studentStatus">Status</label>
    <select id="studentStatus" required>
      <option value="New">New</option>
      <option value="Old">Old</option>
    </select>

    <button type="submit" id="saveBtn">Save Student</button>
    <button type="button" onclick="resetForm()" style="background:#777;">Clear</button>
  </form>
</div>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Search by Student ID, Name, or Class...">
</div>

<div class="table-container">
  <h2>Student List</h2>
  <table id="studentsTable">
    <thead>
      <tr>
        <th>Row</th>
        <th>Student ID</th>
        <th>PIN</th>
        <th>Name</th>
        <th>Class</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="deleteConfirm">
  <p>Are you sure you want to delete this student?</p>
  <button id="confirmDeleteBtn" style="background:#c0392b;">Yes, Delete</button>
  <button onclick="cancelDelete()" style="background:#777;">Cancel</button>
</div>

<div id="message"></div>

<script>
const BASE_URL = 'https://script.google.com/macros/s/AKfycbw9P_XOd4k498l0e4WDbFqAF1asb2u4sRj_uX2B-2S1MvyWOeWQZqxy8dr13mPOdNOeuw/exec';
let loadedStudents = [];
let studentToDelete = null;

async function loadStudents() {
  clearMessage();
  const tbody = document.querySelector('#studentsTable tbody');
  tbody.innerHTML = '<tr><td colspan="7">Loading... <span class="spinner"></span></td></tr>';
  document.getElementById('studentSummary').textContent = 'Loading total students...';

  try {
    const url = new URL(BASE_URL);
    url.searchParams.append('action', 'getStudentPrincipal');
    url.searchParams.append('role', 'principal');

    const res = await fetch(url);
    const data = await res.json();

    if (!data.success) {
      showMessage('Error loading students: ' + data.message, true);
      return;
    }

    loadedStudents = data.students || [];

    const total = loadedStudents.length;
    const totalNew = loadedStudents.filter(s => s.Status === 'New').length;
    const totalOld = loadedStudents.filter(s => s.Status === 'Old').length;

    document.getElementById('studentSummary').textContent =
      `Total Students: ${total} | New: ${totalNew} | Old: ${totalOld}`;

    if (loadedStudents.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7">No students found.</td></tr>';
      return;
    }

    // Show only the most recently added student initially
    filterAndRenderStudents([loadedStudents[loadedStudents.length - 1]]);
  } catch (err) {
    showMessage('Failed to load students: ' + err.message, true);
  }
}

function filterAndRenderStudents(preFiltered = null) {
  const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
  let studentsToFilter;

  if (searchQuery) {
    studentsToFilter = loadedStudents.filter(s =>
      (s.StudentID && s.StudentID.toLowerCase().includes(searchQuery)) ||
      (s.Name && s.Name.toLowerCase().includes(searchQuery)) ||
      (s.Class && s.Class.toLowerCase().includes(searchQuery))
    );
  } else {
    studentsToFilter = preFiltered || [];
  }

  renderStudents(studentsToFilter.length ? studentsToFilter : []);
}

function renderStudents(students) {
  const tbody = document.querySelector('#studentsTable tbody');
  tbody.innerHTML = '';

  if (students.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7">No students found.</td></tr>';
    return;
  }

  students.forEach((student, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${student.StudentID || ''}</td>
      <td>${student.PIN || ''}</td>
      <td>${student.Name || ''}</td>
      <td>${student.Class || ''}</td>
      <td>${student.Status || ''}</td>
      <td class="actions">
        <button onclick="editStudentById('${student.StudentID}')">Edit</button>
        <button onclick="confirmDelete('${student.StudentID}')" style="background:#c0392b;">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById('searchInput').addEventListener('input', filterAndRenderStudents);

function resetForm() {
  document.getElementById('studentForm').reset();
  document.getElementById('editStudentId').value = '';
}

document.getElementById('studentForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  clearMessage();
  const btn = document.getElementById('saveBtn');
  const originalColor = btn.style.backgroundColor;
  btn.disabled = true;
  btn.textContent = 'Saving...';
  btn.insertAdjacentHTML('beforeend', '<span class="spinner"></span>');

  const studentId = document.getElementById('editStudentId').value;
  const name = document.getElementById('studentName').value.trim();
  const studentClass = document.getElementById('studentClass').value.trim();
  const status = document.getElementById('studentStatus').value;

  if (!name || !studentClass || !status) {
    showMessage('Please fill all fields.', true);
    btn.disabled = false;
    btn.textContent = 'Save Student';
    return;
  }

  if (!studentId) {
    await addStudent(name, studentClass, status, btn, originalColor);
  } else {
    await updateStudent(studentId, name, studentClass, status, btn, originalColor);
  }
});

async function addStudent(name, studentClass, status, btn, originalColor) {
  try {
    const res = await fetch(BASE_URL, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({ action:'addStudent', role:'principal', name, class:studentClass, status })
    });
    const data = await res.json();
    if(data.success){
      btn.style.backgroundColor='green';
      showMessage(`Student added successfully. ID: ${data.StudentID}, PIN: ${data.PIN}`);
      resetForm(); loadStudents();
    }else{
      btn.style.backgroundColor='red';
      showMessage('Failed to add student: '+data.message,true);
    }
  }catch(err){
    btn.style.backgroundColor='red';
    showMessage('Error: '+err.message,true);
  }
  setTimeout(()=>{btn.style.backgroundColor=originalColor; btn.disabled=false; btn.textContent='Save Student';},1000);
}

async function updateStudent(studentID,name,studentClass,status,btn,originalColor){
  try{
    const res = await fetch(BASE_URL,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({ action:'editStudent', role:'principal', studentId:studentID, name, class:studentClass, status })
    });
    const data = await res.json();
    if(data.success){ btn.style.backgroundColor='green'; showMessage('Student updated successfully.'); resetForm(); loadStudents(); }
    else{ btn.style.backgroundColor='red'; showMessage('Failed to update student: '+data.message,true);}
  }catch(err){ btn.style.backgroundColor='red'; showMessage('Error: '+err.message,true);}
  setTimeout(()=>{btn.style.backgroundColor=originalColor; btn.disabled=false; btn.textContent='Save Student';},1000);
}

function confirmDelete(studentID){ studentToDelete=studentID; document.getElementById('deleteConfirm').style.display='block'; }
document.getElementById('confirmDeleteBtn').addEventListener('click', async ()=>{
  if(!studentToDelete) return;
  const btn=document.getElementById('confirmDeleteBtn');
  const originalColor=btn.style.backgroundColor;
  btn.disabled=true; btn.textContent='Deleting...'; btn.insertAdjacentHTML('beforeend','<span class="spinner"></span>');

  try{
    const res=await fetch(BASE_URL,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({ action:'deleteStudent', role:'principal', studentId:studentToDelete })
    });
    const data=await res.json();
    if(data.success){ btn.style.backgroundColor='green'; showMessage('Student deleted successfully.'); loadStudents(); }
    else{ btn.style.backgroundColor='red'; showMessage('Failed to delete student: '+data.message,true); }
  }catch(err){ btn.style.backgroundColor='red'; showMessage('Error: '+err.message,true);}
  setTimeout(()=>{ btn.style.backgroundColor=originalColor; btn.disabled=false; btn.textContent='Yes, Delete'; cancelDelete();},1000);
});
function cancelDelete(){ studentToDelete = null; document.getElementById('deleteConfirm').style.display='none'; }

function showMessage(msg,isError=false){
  const messageDiv=document.getElementById('message');
  messageDiv.textContent=msg;
  messageDiv.style.color=isError?'red':'green';
}

function clearMessage(){ document.getElementById('message').textContent=''; }

function editStudentById(studentID){
  const student=loadedStudents.find(s=>s.StudentID===studentID);
  if(!student){ showMessage('Student data not found for editing.',true); return; }
  document.getElementById('editStudentId').value=student.StudentID;
  document.getElementById('studentName').value=student.Name||'';
  document.getElementById('studentClass').value=student.Class||'';
  document.getElementById('studentStatus').value=student.Status||'New';
  window.scrollTo({top:0,behavior:'smooth'});
}

// Initial load
loadStudents();
</script>

</body>
</html>
