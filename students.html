<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Principal Student Management</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #f7f9fc;
  }
  h1 {
    text-align: center;
    color: #004080;
  }
  button {
    margin: 8px 4px;
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    background-color: #0073e6;
    color: white;
    border: none;
    border-radius: 4px;
  }
  button:hover {
    background-color: #005bb5;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: 6px;
    overflow: hidden;
  }
  th, td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: center;
  }
  th {
    background-color: #0073e6;
    color: white;
  }
  input[type="text"], select {
    padding: 6px;
    margin: 4px 0;
    width: 100%;
    box-sizing: border-box;
  }
  #formSection {
    background: white;
    padding: 15px;
    margin-top: 20px;
    border-radius: 6px;
    max-width: 450px;
  }
  #message {
    margin-top: 15px;
    font-weight: bold;
    text-align: center;
  }
</style>
</head>
<body>
  <h1>Principal Student Management</h1>

  <button onclick="fetchStudents()">Refresh Student List</button>

  <table id="studentsTable" style="display:none;">
    <thead>
      <tr>
        <th>StudentID</th>
        <th>PIN</th>
        <th>Name</th>
        <th>Class</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="formSection">
    <h3 id="formTitle">Add New Student</h3>
    <form id="studentForm" onsubmit="handleSubmit(event)">
      <input type="hidden" id="studentIdInput" />
      <label>
        Name:<br />
        <input type="text" id="nameInput" required />
      </label><br />
      <label>
        Class:<br />
        <input type="text" id="classInput" required />
      </label><br />
      <label>
        Status:<br />
        <select id="statusInput" required>
          <option value="New">New</option>
          <option value="Old">Old</option>
        </select>
      </label><br /><br />
      <button type="submit">Save Student</button>
      <button type="button" onclick="resetForm()">Cancel</button>
    </form>
  </div>

  <div id="message"></div>

<script>
  const BASE_URL = 'https://script.google.com/macros/s/AKfycbw9P_XOd4k498l0e4WDbFqAF1asb2u4sRj_uX2B-2S1MvyWOeWQZqxy8dr13mPOdNOeuw/exec';

  async function fetchStudents() {
    clearMessage();
    const table = document.getElementById('studentsTable');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    table.style.display = 'none';

    try {
      const res = await fetch(`${BASE_URL}?action=getStudentList`);
      const data = await res.json();

      if (!data.success) {
        showMessage(`Error: ${data.message}`, true);
        return;
      }

      if (!data.students || data.students.length === 0) {
        showMessage('No students found.');
        return;
      }

      data.students.forEach(student => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${student.StudentID}</td>
          <td>${student.PIN}</td>
          <td>${student.Name}</td>
          <td>${student.Class}</td>
          <td>${student.Status}</td>
          <td>
            <button onclick="editStudent('${student.StudentID}', '${student.Name}', '${student.Class}', '${student.Status}')">Edit</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      table.style.display = '';
    } catch (err) {
      showMessage('Failed to fetch students: ' + err.message, true);
    }
  }

  function editStudent(studentId, name, className, status) {
    document.getElementById('formTitle').textContent = 'Edit Student';
    document.getElementById('studentIdInput').value = studentId;
    document.getElementById('nameInput').value = name;
    document.getElementById('classInput').value = className;
    document.getElementById('statusInput').value = status;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function resetForm() {
    document.getElementById('formTitle').textContent = 'Add New Student';
    document.getElementById('studentIdInput').value = '';
    document.getElementById('nameInput').value = '';
    document.getElementById('classInput').value = '';
    document.getElementById('statusInput').value = 'New';
    clearMessage();
  }

  async function handleSubmit(event) {
    event.preventDefault();
    clearMessage();

    const studentId = document.getElementById('studentIdInput').value.trim();
    const name = document.getElementById('nameInput').value.trim();
    const className = document.getElementById('classInput').value.trim();
    const status = document.getElementById('statusInput').value;

    if (!name || !className) {
      showMessage('Name and Class are required.', true);
      return;
    }

    const params = studentId
      ? { action: 'updateStudent', studentId, name, className, status }
      : { action: 'addStudent', name, className, status };

    try {
      const res = await fetch(BASE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(params)
      });
      const data = await res.json();

      if (data.success) {
        showMessage(data.message || 'Operation successful.');
        resetForm();
        fetchStudents();
      } else {
        showMessage('Error: ' + data.message, true);
      }
    } catch (err) {
      showMessage('Request failed: ' + err.message, true);
    }
  }

  function showMessage(msg, isError = false) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = msg;
    messageDiv.style.color = isError ? 'red' : 'green';
  }

  function clearMessage() {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = '';
  }

  // Load student list on page load
  window.onload = fetchStudents;
</script>
</body>
</html>
