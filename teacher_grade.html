<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Teacher Master Grade Sheet</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #ffc0cb, #800000);
    margin: 0;
    padding: 20px;
  }

  .container {
    background: white;
    border-radius: 12px;
    padding: 25px;
    max-width: 900px;
    margin: 0 auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  }

  h1, h2 {
    color: #800000;
    text-align: center;
    margin-bottom: 20px;
  }

  .teacher-info {
    text-align: center;
    font-weight: 700;
    margin-bottom: 20px;
    font-size: 16px;
    color: #800000;
  }

  label {
    display: block;
    font-weight: 600;
    margin-top: 15px;
    color: #800000;
  }

  select {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    margin-top: 6px;
    font-size: 16px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 25px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: center;
  }

  th {
    background: #f8d7da;
    color: #800000;
  }

  tr:nth-child(even) {
    background: #f9f9f9;
  }

  .btn {
    background-color: #800000;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    margin: 10px 5px 0 0;
    transition: background-color 0.3s;
  }

  .btn:hover {
    background-color: #b22222;
  }

  #loadingMsg {
    text-align: center;
    font-weight: 600;
    margin: 10px 0;
    color: #800000;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Teacher Master Grade Sheet</h1>
  <div class="teacher-info" id="teacherInfo">Loading teacher info...</div>

  <label for="classSelect">Select Class:</label>
  <select id="classSelect"><option>Loading classes...</option></select>

  <label for="studentSelect">Select Student:</label>
  <select id="studentSelect" disabled><option>Select a class first</option></select>

  <p id="loadingMsg"></p>

  <h2>Approved Grades</h2>
  <table id="approvedGradesTable">
    <thead>
      <tr><th>Subject</th><th>Score</th><th>Period</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Rejected Grades</h2>
  <table id="rejectedGradesTable">
    <thead>
      <tr><th>Subject</th><th>Score</th><th>Period</th><th>Reason</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Submitted Grades</h2>
  <table id="submittedGradesTable">
    <thead>
      <tr><th>Subject</th><th>Score</th><th>Period</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbw9P_XOd4k498l0e4WDbFqAF1asb2u4sRj_uX2B-2S1MvyWOeWQZqxy8dr13mPOdNOeuw/exec';

// Load teacher info
const teacher = JSON.parse(localStorage.getItem('teacher') || '{}');
const teacherInfo = document.getElementById('teacherInfo');
if (!teacher.TeacherID) {
  alert('Teacher info not found. Please login.');
  window.location.href = 'teacher_login.html';
} else {
  teacherInfo.textContent = `Welcome, ${teacher.name || teacher.Name || 'Teacher'} | Classes: ${teacher.class || 'N/A'}`;
}

// Populate class dropdown
const classSelect = document.getElementById('classSelect');
const studentSelect = document.getElementById('studentSelect');
const loadingMsg = document.getElementById('loadingMsg');
let selectedStudentId = null;

// Classes from teacher info
const classes = (teacher.class || '').split(',').map(c => c.trim()).filter(Boolean);
classSelect.innerHTML = '<option value="">-- Select Class --</option>';
classes.forEach(c => {
  const opt = document.createElement('option');
  opt.value = c;
  opt.textContent = c;
  classSelect.appendChild(opt);
});

// When class changes, load students for that class
classSelect.addEventListener('change', () => {
  const className = classSelect.value;
  if (!className) {
    studentSelect.innerHTML = '<option>Select a class first</option>';
    studentSelect.disabled = true;
    return;
  }

  studentSelect.disabled = false;
  studentSelect.innerHTML = '<option>Loading students...</option>';
  loadingMsg.textContent = '';

  fetch(`${GAS_URL}?action=getStudentList&role=teacher&teacherId=${encodeURIComponent(teacher.TeacherID)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.success) throw new Error(data.message);
      const students = data.data.filter(s => s.Class === className);
      if (!students.length) {
        studentSelect.innerHTML = '<option>No students in this class</option>';
        return;
      }
      studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
      students.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.StudentID || s.ID;
        opt.textContent = s.Name || s.FullName || 'Unnamed Student';
        studentSelect.appendChild(opt);
      });
    })
    .catch(err => {
      studentSelect.innerHTML = '<option>Error loading students</option>';
      console.error(err);
    });
});

// When student changes, load grades
studentSelect.addEventListener('change', () => {
  selectedStudentId = studentSelect.value;
  if (!selectedStudentId) return;
  loadGrades('getTeacherGrades', 'approvedGradesTable');
  loadGrades('getRejectedGradesWithRow', 'rejectedGradesTable');
  loadGrades('viewSubmittedGrades', 'submittedGradesTable');
});

function loadGrades(action, tableId) {
  const tableBody = document.querySelector(`#${tableId} tbody`);
  tableBody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

  fetch(`${GAS_URL}?action=${action}&role=teacher&teacherId=${encodeURIComponent(teacher.TeacherID)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.success) throw new Error(data.message);
      const grades = data.data.filter(g => g.StudentID === selectedStudentId);
      if (!grades.length) {
        tableBody.innerHTML = `<tr><td colspan="${tableId==='rejectedGradesTable'?5:3}">No grades found</td></tr>`;
        return;
      }
      tableBody.innerHTML = '';
      grades.forEach(g => {
        let row = document.createElement('tr');
        if (tableId === 'rejectedGradesTable') {
          row.innerHTML = `
            <td>${g.Subject}</td>
            <td>${g.Score}</td>
            <td>${g.Period}</td>
            <td>${g.RejectReason || ''}</td>
            <td><button class="btn" style="padding:5px 10px;" onclick="alert('Edit row ${g.row}')">Edit</button></td>
          `;
        } else {
          row.innerHTML = `<td>${g.Subject}</td><td>${g.Score}</td><td>${g.Period}</td>`;
        }
        tableBody.appendChild(row);
      });
    })
    .catch(err => {
      tableBody.innerHTML = `<tr><td colspan="5" style="color:red;">Error: ${err.message}</td></tr>`;
    });
}
</script>
</body>
</html>
