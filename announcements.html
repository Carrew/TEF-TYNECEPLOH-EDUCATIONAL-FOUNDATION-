<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>School Announcements</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 20px auto;
      padding: 0 10px;
    }
    h1, h2 {
      text-align: center;
    }
    .announcement {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      background: #f9f9f9;
      position: relative;
    }
    .announcement h3 {
      margin: 0 0 5px;
    }
    .announcement small {
      color: #666;
      font-size: 0.9em;
    }
    .actions {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .actions button {
      margin-left: 5px;
      background-color: #007bff;
      border: none;
      color: white;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .actions button.delete {
      background-color: #dc3545;
    }
    .actions button.cancel {
      background-color: #6c757d;
    }
    .actions button.save {
      background-color: #28a745;
    }
    form {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #f1f1f1;
    }
    form div {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    input[type="text"],
    textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      font-size: 1em;
    }
    textarea {
      resize: vertical;
      height: 80px;
    }
    button.submit-btn {
      background-color: #007bff;
      border: none;
      color: white;
      padding: 10px 18px;
      cursor: pointer;
      font-size: 1em;
      border-radius: 4px;
    }
    button.submit-btn:hover {
      background-color: #0056b3;
    }
    #message {
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
    }
    #message.error {
      color: red;
    }
    #message.success {
      color: green;
    }
  </style>
</head>
<body>

<h1>School Announcements</h1>

<div id="message"></div>

<!-- Form to add new announcement -->
<form id="announcementForm">
  <h2>Add New Announcement</h2>
  <div>
    <label for="title">Title *</label>
    <input type="text" id="title" required />
  </div>
  <div>
    <label for="messageInput">Message *</label>
    <textarea id="messageInput" required></textarea>
  </div>
  <button type="submit" class="submit-btn">Add Announcement</button>
</form>

<div id="announcements">Loading announcements...</div>

<script>
  const announcementsContainer = document.getElementById('announcements');
  const messageDiv = document.getElementById('message');
  const baseUrl = "https://script.google.com/macros/s/AKfycbw9P_XOd4k498l0e4WDbFqAF1asb2u4sRj_uX2B-2S1MvyWOeWQZqxy8dr13mPOdNOeuw/exec";

  // Show message
  function showMessage(msg, isError = false) {
    messageDiv.textContent = msg;
    messageDiv.className = isError ? 'error' : 'success';
  }

  // Clear message
  function clearMessage() {
    messageDiv.textContent = '';
    messageDiv.className = '';
  }

  // Fetch and display announcements
  async function fetchAnnouncements() {
    clearMessage();
    try {
      const response = await fetch(baseUrl + '?action=getAnnouncements');
      if (!response.ok) throw new Error('Network response was not ok');

      const data = await response.json();

      announcementsContainer.innerHTML = ''; // Clear loading text

      if (data.success && data.announcements.length > 0) {
        data.announcements.forEach(announcement => {
          const dateStr = new Date(announcement.date).toLocaleDateString();
          const div = document.createElement('div');
          div.className = 'announcement';
          div.dataset.id = announcement.announcementId;
          div.innerHTML = `
            <h3 class="title">${escapeHtml(announcement.title || 'No Title')}</h3>
            <small>${dateStr}</small>
            <p class="message">${escapeHtml(announcement.message || 'No Message')}</p>
            <div class="actions">
              <button class="edit">Edit</button>
              <button class="delete">Delete</button>
            </div>
          `;
          announcementsContainer.appendChild(div);
        });
        attachAnnouncementEvents();
      } else {
        announcementsContainer.textContent = 'No announcements found.';
      }
    } catch (error) {
      announcementsContainer.textContent = 'Failed to load announcements: ' + error.message;
    }
  }

  // Escape HTML for safety
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'}[m];
    });
  }

  // Attach edit and delete event listeners
  function attachAnnouncementEvents() {
    document.querySelectorAll('.announcement .edit').forEach(button => {
      button.onclick = (e) => {
        const container = e.target.closest('.announcement');
        if (container.classList.contains('editing')) return; // Prevent multiple edits

        container.classList.add('editing');

        const titleEl = container.querySelector('.title');
        const messageEl = container.querySelector('.message');
        const actionsEl = container.querySelector('.actions');

        // Save original content
        const originalTitle = titleEl.textContent;
        const originalMessage = messageEl.textContent;

        // Replace with inputs
        titleEl.innerHTML = `<input type="text" class="edit-title" value="${escapeHtml(originalTitle)}" style="width: 100%; font-size:1.2em; padding:4px;" />`;
        messageEl.innerHTML = `<textarea class="edit-message" style="width: 100%; height: 80px; padding:4px;">${escapeHtml(originalMessage)}</textarea>`;

        // Replace buttons with Save and Cancel
        actionsEl.innerHTML = `
          <button class="save">Save</button>
          <button class="cancel">Cancel</button>
        `;

        // Cancel button handler
        actionsEl.querySelector('.cancel').onclick = () => {
          titleEl.textContent = originalTitle;
          messageEl.textContent = originalMessage;
          resetActions(container);
          container.classList.remove('editing');
        };

        // Save button handler
        actionsEl.querySelector('.save').onclick = async () => {
          clearMessage();

          const newTitle = actionsEl.closest('.announcement').querySelector('.edit-title').value.trim();
          const newMessage = actionsEl.closest('.announcement').querySelector('.edit-message').value.trim();

          if (!newTitle || !newMessage) {
            showMessage("Title and Message cannot be empty.", true);
            return;
          }

          const announcementId = container.dataset.id;
          const params = new URLSearchParams();
          params.append('action', 'editAnnouncement');
          params.append('announcementId', announcementId);
          params.append('title', newTitle);
          params.append('message', newMessage);

          try {
            const res = await fetch(baseUrl, {
              method: 'POST',
              body: params
            });
            const data = await res.json();

            if (!data.success) throw new Error(data.message || 'Failed to update announcement');

            showMessage("Announcement updated successfully!");
            fetchAnnouncements();
          } catch (err) {
            showMessage('Error updating announcement: ' + err.message, true);
          }
        };
      };
    });

    document.querySelectorAll('.announcement .delete').forEach(button => {
      button.onclick = async (e) => {
        clearMessage();
        if (!confirm("Are you sure you want to delete this announcement?")) return;

        const container = e.target.closest('.announcement');
        const announcementId = container.dataset.id;

        const params = new URLSearchParams();
        params.append('action', 'deleteAnnouncement');
        params.append('announcementId', announcementId);

        try {
          const res = await fetch(baseUrl, {
            method: 'POST',
            body: params
          });
          const data = await res.json();

          if (!data.success) throw new Error(data.message || 'Failed to delete announcement');

          showMessage("Announcement deleted successfully!");
          fetchAnnouncements();
        } catch (err) {
          showMessage('Error deleting announcement: ' + err.message, true);
        }
      };
    });
  }

  // Reset action buttons after edit/cancel
  function resetActions(container) {
    container.querySelector('.actions').innerHTML = `
      <button class="edit">Edit</button>
      <button class="delete">Delete</button>
    `;
    attachAnnouncementEvents();
  }

  // Add new announcement form handler
  document.getElementById('announcementForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearMessage();

    const title = document.getElementById('title').value.trim();
    const message = document.getElementById('messageInput').value.trim();

    if (!title || !message) {
      showMessage("Please fill in all required fields.", true);
      return;
    }

    const params = new URLSearchParams();
    params.append('action', 'addAnnouncement');
    params.append('title', title);
    params.append('message', message);

    try {
      const response = await fetch(baseUrl, {
        method: 'POST',
        body: params
      });
      const data = await response.json();

      if (!data.success) throw new Error(data.message || 'Failed to add announcement');

      showMessage("Announcement added successfully!");
      e.target.reset();
      fetchAnnouncements();
    } catch (error) {
      showMessage('Error adding announcement: ' + error.message, true);
    }
  });

  // Initial fetch
  fetchAnnouncements();
</script>

</body>
</html>
