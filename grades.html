<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Principal Grades Management</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    background-color: #f4f6f8;
    color: #222;
  }
  h1 {
    text-align: center;
    color: #1a3e72;
  }
  #buttons {
    text-align: center;
    margin-bottom: 15px;
  }
  button {
    margin: 0 8px 12px;
    padding: 10px 18px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    background-color: #1a3e72;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #16335a;
  }
  #searchContainer {
    max-width: 900px;
    margin: 10px auto 20px auto;
    text-align: center;
  }
  #searchInput {
    width: 300px;
    padding: 8px 12px;
    font-size: 16px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 12px 10px;
    border: 1px solid #ddd;
    text-align: center;
    font-size: 14px;
  }
  th {
    background-color: #1a3e72;
    color: white;
  }
  td button {
    background-color: #2e7d32;
    font-size: 13px;
    padding: 6px 12px;
  }
  td button:hover {
    opacity: 0.85;
  }
  #message {
    margin: 15px 0;
    text-align: center;
    font-weight: 600;
    min-height: 24px;
  }
</style>
</head>
<body>
  <h1>Principal Grades Management</h1>

  <div id="buttons">
    <button onclick="loadGrades('getSubmittedGrades')">Submitted Grades</button>
    <button onclick="loadGrades('getApprovedGradesAdmin')">Approved Grades</button>
  </div>

  <div id="searchContainer" style="display:none;">
    <input type="text" id="searchInput" placeholder="Search by Student ID, Name, Subject, Class, or Teacher ID..." />
  </div>

  <div id="message"></div>

  <table id="gradesTable" style="display:none;">
    <thead>
      <tr>
        <th>Student ID</th>
        <th>Name</th>
        <th>Subject</th>
        <th>Score</th>
        <th>Period</th>
        <th>Teacher ID</th>
        <th>Status</th>
        <th>Reject Reason</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const BASE_URL = 'https://script.google.com/macros/s/AKfycbw9P_XOd4k498l0e4WDbFqAF1asb2u4sRj_uX2B-2S1MvyWOeWQZqxy8dr13mPOdNOeuw/exec';

    const messageDiv = document.getElementById('message');
    const gradesTable = document.getElementById('gradesTable');
    const tbody = gradesTable.querySelector('tbody');
    const searchContainer = document.getElementById('searchContainer');
    const searchInput = document.getElementById('searchInput');

    let allGrades = [];
    let allStudents = [];

    // Helper: safely get studentId field from grade object
    function getStudentId(grade) {
      return grade.studentId || grade.StudentID || grade.id || '';
    }
    // Helper: safely get name field from student object with common guesses
    function getStudentName(student) {
      return student.Name || student.name || student.FullName || student.fullName || student.StudentName || student.studentName || "Unknown";
    }
    // Helper: match student by studentId (case insensitive)
    function findStudentNameById(studentId) {
      if (!studentId) return "Unknown";
      const id = studentId.toString().trim().toLowerCase();
      const student = allStudents.find(s => {
        const sid = (s.StudentID || s.studentId || s.id || "").toString().trim().toLowerCase();
        return sid === id;
      });
      if (student) return getStudentName(student);
      return "Unknown";
    }

    async function loadGrades(action) {
      clearMessage();
      tbody.innerHTML = '';
      gradesTable.style.display = 'none';
      searchContainer.style.display = 'none';
      searchInput.value = '';

      try {
        // Load grades
        const urlGrades = new URL(BASE_URL);
        urlGrades.searchParams.append('action', action);
        urlGrades.searchParams.append('role', 'principal');
        const resGrades = await fetch(urlGrades);
        const dataGrades = await resGrades.json();

        if (!dataGrades.success) {
          showMessage(`Error: ${dataGrades.message}`, true);
          return;
        }
        if (!dataGrades.grades || dataGrades.grades.length === 0) {
          showMessage('No grades found.');
          return;
        }
        allGrades = dataGrades.grades;

        // Load students list to find names
        const urlStudents = new URL(BASE_URL);
        urlStudents.searchParams.append('action', 'getStudentList');
        urlStudents.searchParams.append('role', 'principal');
        const resStudents = await fetch(urlStudents);
        const dataStudents = await resStudents.json();

        if (!dataStudents.success) {
          showMessage(`Error loading students: ${dataStudents.message}`, true);
          return;
        }
        allStudents = dataStudents.data || [];

        renderGrades(allGrades);

        gradesTable.style.display = '';
        searchContainer.style.display = '';
      } catch (error) {
        showMessage('Failed to load grades: ' + error.message, true);
      }
    }

    function renderGrades(grades) {
      tbody.innerHTML = '';
      grades.forEach(grade => {
        const sid = getStudentId(grade);
        const studentName = findStudentNameById(sid);

        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${escapeHTML(sid)}</td>
          <td>${escapeHTML(studentName)}</td>
          <td>${escapeHTML(grade.subject)}</td>
          <td>${escapeHTML(grade.score)}</td>
          <td>${escapeHTML(grade.period)}</td>
          <td>${escapeHTML(grade.teacherId)}</td>
          <td>${escapeHTML(grade.status)}</td>
          <td>${escapeHTML(grade.rejectReason || '')}</td>
          <td>
            ${grade.status === 'Submitted' ? `
              <button onclick="approveGrade(${grade.row})">Approve</button>
              <button onclick="rejectGrade(${grade.row})">Reject</button>
            ` : ''}
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // Search filter function
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.trim().toLowerCase();
      if (!query) {
        renderGrades(allGrades);
        return;
      }
      const filtered = allGrades.filter(grade => {
        const sid = getStudentId(grade).toLowerCase();
        const studentName = findStudentNameById(sid).toLowerCase();
        return (
          sid.includes(query) ||
          studentName.includes(query) ||
          (grade.subject && grade.subject.toLowerCase().includes(query)) ||
          (grade.class && grade.class.toLowerCase().includes(query)) ||  // if exists
          (grade.teacherId && grade.teacherId.toLowerCase().includes(query))
        );
      });
      renderGrades(filtered);
    });

    async function approveGrade(row) {
      clearMessage();
      try {
        const res = await fetch(BASE_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: new URLSearchParams({
            action: 'approveGrades',
            role: 'principal',
            rows: JSON.stringify([row])
          })
        });
        const data = await res.json();

        if (data.success) {
          showMessage('Grade approved successfully.');
          loadGrades('getSubmittedGrades');
        } else {
          showMessage('Failed to approve grade: ' + data.message, true);
        }
      } catch (error) {
        showMessage('Error: ' + error.message, true);
      }
    }

    async function rejectGrade(row) {
      clearMessage();
      const reason = prompt('Please enter the reason for rejection:');
      if (!reason) {
        showMessage('Rejection cancelled.');
        return;
      }

      try {
        const res = await fetch(BASE_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: new URLSearchParams({
            action: 'rejectGrades',
            role: 'principal',
            row: row,
            rejectReason: reason
          })
        });
        const data = await res.json();

        if (data.success) {
          showMessage('Grade rejected successfully.');
          loadGrades('getSubmittedGrades');
        } else {
          showMessage('Failed to reject grade: ' + data.message, true);
        }
      } catch (error) {
        showMessage('Error: ' + error.message, true);
      }
    }

    function showMessage(msg, isError = false) {
      messageDiv.textContent = msg;
      messageDiv.style.color = isError ? 'red' : 'green';
    }

    function clearMessage() {
      messageDiv.textContent = '';
    }

    // Basic HTML escape to avoid injection
    function escapeHTML(str) {
      if (!str) return '';
      return str.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
